---
title: "Relación del las tempertatura con la diabetes"
author: "Mario Benito, Guillermo de la Fuente,Pablo Fernández"
date: "`r Sys.Date()`"
output: html_document
---

# Este es el HTML que hemos de entregar

[GitHub](https://github.com/Pindulfo/Seminario_A.git) \### 1. Carga de paquetes Estos son los paquetes necesarios para la carga de archivos Pc-axis, la obtención de datos de la aemet y su manipulación.

```{r echo=FALSE}
# install.packages("climaemet")
library(pxR)
library(climaemet)
library(dplyr)
library(stringr)

## Use this function to register your API Key temporarly or permanently
# aemet_api_key("eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJmcGFibG81NDVAZ21haWwuY29tIiwianRpIjoiYTI2NWIyNzQtY2M4OS00NWZmLThlNGYtMWJlYWQ2NTA1MTAxIiwiaXNzIjoiQUVNRVQiLCJpYXQiOjE3MjkzNTMxNTgsInVzZXJJZCI6ImEyNjViMjc0LWNjODktNDVmZi04ZTRmLTFiZWFkNjUwNTEwMSIsInJvbGUiOiIifQ.TGFw-QlkAkMyQ2hItIpbSF_xDIoN42JpIzUhf-dOm3A", install= TRUE)
```

### Obtención datos diabetes

Obtenemos los nombres de archivos con datos de diabetes

```{r}
archivos <- list.files('INPUT/DATA/Diabetes/Ingresos/', pattern = '*.px')
```

Añadimos la ruta completa de cada archivo

```{r}
archivos_pc <- sapply(archivos, function(x) paste0('INPUT/DATA/Diabetes/Ingresos/', x))
```

Creamos el dataframe base con el primer archivo, que servirá para concatenar los datos de años siguientes

```{r}
df_i <- data.frame(as.data.frame(read.px(archivos_pc[1])))
df_i['Año'] <- 1997  # Añadir columna de año
```

Bucle para añadir cada año al dataframe

```{r}
for (i in 2:length(archivos_pc)) {
  # Cargar los datos del año específico
  df_provisional <- data.frame(as.data.frame(read.px(archivos_pc[i])))
  
  # Extraer el año del nombre del archivo
  año <- unlist(strsplit(archivos[i], "\\."))[1]
  año <- substr(año, nchar(año) - 3, nchar(año))
  
  # Añadir columna de año al nuevo dataframe
  df_provisional['Año'] <- año
  
  # Asegurar que las columnas coincidan
  colnames(df_provisional) <- colnames(df_i)
  
  # Concatenar el dataframe con el del año anterior
  df_i <- rbind(df_i, df_provisional)
}
```

Visualizar la estructura de los datos

```{r}
head(df_i)
```

# Código para Limpiar y estandarizar nombres de provincias en `Provincia.de.hospitalización`

Analizamos los valores de cada atributo, por ejemplo, las provincias de hospitalización

```{r}
factor(df_i$Provincia.de.hospitalización)
```

Limpiamos los nombres de las provincias: eliminamos números y ajustamos algunos nombres para normalización

```{r}
df_i$Provincia.de.hospitalización <- str_replace_all(df_i$Provincia.de.hospitalización,"[0123456789]","") %>% 
  str_replace_all("^ ","") %>% 
  str_replace_all("Araba/Á","A") %>% 
  str_replace_all("/Alacant", '') %>% 
  str_replace_all("ANDALUCÍA", 'Andalucía') %>% 
  str_replace_all('ARAGÓN', 'Aragón') %>% 
  str_replace_all('ASTURIAS','Asturias') %>% 
  str_replace_all('Asturias \\(Principado de\\)', 'Asturias') %>%
  str_replace_all('Asturias, Principado de', 'Asturias') %>%  
  str_replace_all('Asturias, PRINCIPADO DE', 'Asturias') %>%
  str_replace_all('Ávila', 'Avila') %>% 
  str_replace_all('BALEARS, ILLES', 'Baleares') %>% 
  str_replace_all('Balears, Illes', 'Baleares') %>% 
  str_replace_all('Balears \\(Illes\\)', 'Baleares') %>% 
  str_replace_all("CANARIAS", 'Canarias') %>% 
  str_replace_all("CANTABRIA", 'Cantabria') %>% 
  str_replace_all("Castellón de la Plana", 'Castellón') %>% 
  str_replace_all("/Castelló", '') %>% 
  str_replace_all("CASTILLA - LA MANCHA", 'Castilla - La Mancha') %>% 
  str_replace_all("CASTILLA Y LEÓN", 'Castilla y León') %>% 
  str_replace_all("CATALUÑA", 'Cataluña') %>% 
  str_replace_all("Comunitat Valenciana", 'Comunidad Valenciana') %>% 
  str_replace_all("COMUNITAT VALENCIANA", 'Comunidad Valenciana') %>% 
  str_replace_all("Coruña \\(A\\)", 'A Coruña') %>% #revisar el Coruña (A) no se ha modificado con esto
  str_replace_all("Coruña, A", 'A Coruña') %>% 
  str_replace_all("EXTREMADURA", 'Extremadura') %>% 
  str_replace_all("GALICIA", 'Galicia') %>% 
  str_replace_all("Guipúzcoa", 'Gipuzkoa') %>% 
  str_replace_all('MADRID, COMUNIDAD DE','Madrid') %>% #revisar al igual que asturias para que solo salga Madrid
  str_replace_all('Madrid, Comunidad de', 'Madrid') %>%
  str_replace_all('Madrid \\(Comunidad de\\)', 'Madrid') %>% 
  str_replace_all('MURCIA, REGIÓN DE','Murcia') %>% #revisar para que solo salga Murcia
  str_replace_all('Murcia \\(Región de\\)','Murcia') %>%
  str_replace_all('Murcia, Región de','Murcia') %>%
  str_replace_all('Murcia*', 'Murcia') %>% 
  str_replace_all('NAVARRA, COMUNIDAD FORAL DE','Navarra') %>% #revisar para que salga solo Navarra
  str_replace_all('Navarra \\(Comun. Foral de\\)', 'Navarra') %>%
  str_replace_all('Navarra, Comunidad Foral de', 'Navarra') %>% 
  str_replace_all('PAÍS VASCO', 'País Vasco') %>% 
  str_replace_all("Palmas \\(Las\\)", 'Las Palmas') %>% #revisar el Palmas (Las) no se ha modificado con esto
  str_replace_all("Palmas, Las", 'Las Palmas') %>%
  str_replace_all("Rioja \\(La\\)", 'La Rioja') %>% #revisar Rioja (La) no se ha modificado con esto
  str_replace_all("Rioja, La", 'La Rioja') %>%
  str_replace_all("RIOJA, LA", 'La Rioja') %>% 
  str_replace_all("TOTAL NACIONAL", 'Total') %>% 
  str_replace_all("Total Nacional", 'Total') %>% 
  str_replace_all("/València", '') %>% 
  str_replace_all("Bizkaia", 'Vizcaya')
```  

Comprobamos de neuvo los distintos valores
```{r}
len(factor(df_i$Provincia.de.hospitalización))
```

# Cargamos los datos de muertes

```{r}
datos_muertes <- read.px('INPUT/DATA/Diabetes/Muertes/muertes1997-2022.px')
```

Conviertimos los datos de muertes a un dataframe para facilitar el análisis

```{r}
df_m <- as.data.frame(datos_muertes)
```

Mostramos las primeras filas del dataframe para verificar la carga de datos

```{r}
head(df_m)
```

### Obtención de datos de la aemet

Se recogen todas las estaciones de la aemet. A continuación, se muestra la estructura de los datos.

```{r}
estaciones <- aemet_stations()
head(estaciones)
```

Selección de los códigos de las estaciones meteorológicas de interés. El código ampliado se puede ver en Anexo

```{r}
codigos <- c("C449C", "C658L", "0076", "0367", "1212E", "1387", "1484C", "1505", "1690A", "2030", "2331", "2422", "2465", "2614", "2870", "3129", "3013", "3260B", "4121", "4452", "4642E", "5000C", "5530E", "5783", "6000A", "7178I", "8025", "8096", "8178D", "8368U", "8414A", "9434", "9771C", "9898", "6325O", "9091O", "2444", "B278", "1082", "3469A", "5973", "1111", "8500A", "5402", "1014", "5270B", "9170", "6155A", "9263D", "0016A", "2661", "2235U")
```

Generación del dataframe `Datos_met`donde se almacenarán los datos.

```{r}
datos_met <- data.frame(matrix(ncol = 5))
colnames(datos_met) <- c('codigo', 'ta_max', 'ta_min', 'tm_mes', 'año')

```

Obtención de los datos de tempertatura máxima, mínima y media mesual durante los ños 2003 a 2020 de todas las estaciones selecionadas.
A continuación, se muestra el código para acceder a la aemet. Para una mayor rapidez de renderizado se importan los datos.

```{r eval=FALSE}
for (año in 2003:2020){
  print(año)
  for (i in codigos){
    print(i)
    met_prov <- as.data.frame(aemet_monthly_clim(i, year = año)) %>% 
      slice (1:12) %>% 
      select(c('ta_max', 'ta_min', 'tm_mes'))
    
    met_prov$ta_max <- sapply(met_prov$ta_max, FUN = function(x) as.numeric(unlist(strsplit(x, '\\('))[1]) )
    met_prov$ta_min <- sapply(met_prov$ta_min, FUN = function(x) as.numeric(unlist(strsplit(x, '\\('))[1]) )
    
    
    met_procesados <-  data.frame('codigo' = i,
                                  'ta_max' = max(met_prov$ta_max, na.rm = TRUE), 
                                  'ta_min' = min(met_prov$ta_min, na.rm = TRUE), 
                                  'tm_mes' = mean(met_prov$tm_mes, na.rm = TRUE),
                                  'año' = año)
    # print(met_procesados)
    datos_met <- rbind(datos_met, met_procesados)
    # print(datos_met)
    Sys.sleep(1.5)
  }
}

```

```{r}
datos_met <- load('datos_aemet.RData')
head(datos_met)
```

Muestra de cómo se estructura la información de la consulta a aemet.
```{r, echo=FALSE}
met_prov <- as.data.frame(aemet_monthly_clim('C449C', year = 2020))

```

```{r}
head(met_prov)
```

## Esto es una prueba del shiny e inicio del mismo

Para poder ejecutar esto correctamente hemos de insertar la carga de datos etc arriba

```{r}
library(shiny)
library(ggplot2)
# Supongamos que el dataframe ya está cargado en tu entorno de trabajo con el nombre df_i

# Interfaz de usuario
ui <- fluidPage(
  titlePanel("Comparación de Casos por Provincia entre Dos Años"),
  sidebarLayout(
    sidebarPanel(
      selectInput("year1", "Seleccione el primer año:", choices = NULL),  # Se llenará dinámicamente
      selectInput("year2", "Seleccione el segundo año:", choices = NULL), # Se llenará dinámicamente
      selectInput("sex", "Seleccione el sexo:", choices = NULL)           # Se llenará dinámicamente
    ),
    mainPanel(
      plotOutput("histPlot")
    )
  )
)

# Servidor
server <- function(input, output, session) {
  # Actualizar las opciones de los menús desplegables dinámicamente
  observe({
    updateSelectInput(session, "year1", choices = unique(df_i$Año))
    updateSelectInput(session, "year2", choices = unique(df_i$Año))
    updateSelectInput(session, "sex", choices = unique(df_i$Sexo))
  })
  
  output$histPlot <- renderPlot({
    # Filtrar los datos en función de los años y el sexo seleccionados
    datos_filtrados <- df_i[(df_i$Año == input$year1 | df_i$Año == input$year2) & df_i$Sexo == input$sex, ]
    
    # Crear el histograma comparativo
    ggplot(datos_filtrados, aes(x = Provincia.de.hospitalización, y = value, fill = as.factor(Año))) +
      geom_bar(stat = "identity", position = "dodge") +
      theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
      labs(x = "Provincia", y = "Casos", title = paste("Comparación de casos entre", input$year1, "y", input$year2),
           fill = "Año")
  })
}

# Correr la aplicación
shinyApp(ui = ui, server = server)


```
